
#!/bin/bash

echo "=============================================="
echo "RUNNING CUDA TESTS WITH DIFFERENT BLOCK SIZES"
echo "=============================================="
echo ""

# Check if CUDA file exists
if [ ! -f "vector_add_cuda.cu" ]; then
    echo "ERROR: vector_add_cuda.cu not found!"
    exit 1
fi

# Check if nvcc is available
if ! command -v nvcc &> /dev/null; then
    echo "ERROR: nvcc (CUDA compiler) not found!"
    echo "Install CUDA toolkit first: https://developer.nvidia.com/cuda-downloads"
    exit 1
fi

echo "CUDA compiler found: $(nvcc --version | head -1)"
echo ""

# Compile CUDA program
echo "Compiling vector_add_cuda.cu..."
echo "---------------------------------"
nvcc vector_add_cuda.cu -o cuda_test

if [ $? -ne 0 ]; then
    echo "CUDA compilation failed!"
    exit 1
fi

echo "CUDA compilation successful!"
echo ""

# Create output directory
mkdir -p cuda_outputs

echo "Starting CUDA tests..."
echo "======================"
echo ""

# Test different thread block sizes
echo "Testing with different thread block configurations..."
echo ""

# Common configurations to test
configs=(
    "32"    # 32 threads per block
    "64"    # 64 threads per block  
    "128"   # 128 threads per block
    "256"   # 256 threads per block
    "512"   # 512 threads per block
)

echo "Threads/Block | Time (seconds)"
echo "--------------|----------------"

for threads in "${configs[@]}"; do
    echo -n "      $threads      | "
    
    # Run CUDA program
    output=$(./cuda_test $threads 2>&1)
    echo "$output" > "cuda_outputs/${threads}_threads.txt"
    
    # Extract time
    time=$(echo "$output" | grep "Time:" | awk '{print $2}')
    echo "$time"
done

echo ""
echo "=============================================="
echo "CUDA TESTS COMPLETED!"
echo "=============================================="
echo ""
echo "Output files created in cuda_outputs/:"
ls -la cuda_outputs/
